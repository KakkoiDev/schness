<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schness</title>
    <link rel="icon" href="/public/king-white.svg" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <script type="module">
      import van from "https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.5.0.min.js";
      import {
        handlePickup,
        handleDrop,
        addEventListenersToDocument,
        getPieceSrc,
      } from "/lib/index.js";
      import {
        pieces,
        squares,
        colors,
        initialPiecesPosition,
      } from "/data/index.js";

      const { div, img } = van.tags;

      const movingPiece = van.state(null);
      const history = van.state([new Array(16).fill(0)]);
      const possibleMoves = van.state(new Array(16).fill(false));

      addEventListenersToDocument({ movingPiece, history, possibleMoves });

      const piece = (props) =>
        img({
          ...props,
          onpointerdown: (event) =>
            handlePickup({ event, movingPiece, history, possibleMoves }),
          className: "piece",
        });

      const bank = ({ color }) => {
        return () =>
          div(
            { className: "bank" },
            initialPiecesPosition.map((p, index) => {
              const pieceSrc = getPieceSrc({ piece: p, color });
              const indexModifier = color === colors.black ? 5 : 1;
              const computedIndex = index + indexModifier;

              if (
                history.val.at(-1).includes(computedIndex) ||
                Number(movingPiece.val?.dataset.index) === computedIndex
              ) {
                return div({ className: "square" });
              }

              return div(
                { className: "square" },
                piece({
                  src: pieceSrc,
                  "data-type": p,
                  "data-color": color,
                  "data-index": computedIndex,
                })
              );
            })
          );
      };

      const square = (props) => {
        return () =>
          div(
            {
              className: `square ${
                possibleMoves.val[props.index]
                  ? colors.info
                  : props.color === colors.white
                  ? colors.white
                  : colors.black
              }`,
              "data-index": props.index,
            },
            () => {
              const squareIndex = history.val.at(-1)[props.index];
              const movingPieceIndex = Number(movingPiece.val?.dataset.index);

              if (squareIndex !== 0 && squareIndex !== movingPieceIndex) {
                const type = initialPiecesPosition[(squareIndex - 1) % 4];
                const color =
                  squareIndex - 1 < initialPiecesPosition.length
                    ? colors.white
                    : colors.black;
                const pieceSrc = getPieceSrc({ piece: type, color });

                return piece({
                  src: pieceSrc,
                  "data-type": type,
                  "data-color": color,
                  "data-index": squareIndex,
                });
              }
            }
          );
      };

      const cursorSquare = div(
        {
          id: "cursor-square",
          className: "square cursor-square",
        },
        () => {
          const pieceVal = movingPiece.val;
          let pieceElement = null;

          if (pieceVal) {
            const type = pieceVal.dataset.type;
            const color = pieceVal.dataset.color;
            const index = pieceVal.dataset.index;
            pieceElement = piece({
              src: getPieceSrc({ piece: type, color }),
              "data-type": type,
              "data-color": color,
              "data-index": index,
            });
          }

          return div(pieceElement);
        }
      );

      const board = () =>
        div(
          {
            className: "board",
          },
          squares.map((color, index) => square({ color, index }))
        );

      const game = div(
        bank({ color: colors.black }),
        board,
        bank({ color: colors.white }),
        cursorSquare
      );

      van.add(document.body, game);
    </script>
  </body>
</html>
