<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schness</title>
    <link rel="icon" href="/public/king-white.svg" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <script type="module">
      import van from "https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.5.0.min.js";
      const { div, img } = van.tags;
      import {
        handlePickup,
        handleMove,
        handleDrop,
        addEventListenersToDocument,
        getPieceName,
      } from "/lib/index.js";
      import {
        pieces,
        squares,
        colors,
        initialPiecesPosition,
      } from "/data/index.js";

      const renderGame = () => {
        const movingPiece = van.state(null);
        const history = van.state([new Array(16).fill(0)]);
        const possibleMoves = van.state(new Array(16).fill(false));

        addEventListenersToDocument({ movingPiece });

        const piece = (props) =>
          img({
            ...props,
            ontouchstart: (event) =>
              handlePickup({ event, movingPiece, history, possibleMoves }),
            onmousedown: (event) =>
              handlePickup({ event, movingPiece, history, possibleMoves }),
            className: "piece",
          });

        const bank = ({ color }) =>
          div(
            { className: "bank" },
            initialPiecesPosition.map((p, index) => {
              const pieceName = getPieceName({ piece: p, color });
              const indexModifier = color === colors.black ? 5 : 1;

              return div(
                { id: pieceName, className: "square" },
                piece({
                  src: `/public/${pieceName}.svg`,
                  "data-type": p,
                  "data-color": color,
                  "data-index": index + indexModifier,
                })
              );
            })
          );

        const square = (props) => {
          return () =>
            div(
              {
                className: `square ${
                  possibleMoves.val[props.index]
                    ? colors.info
                    : props.color === colors.white
                    ? colors.white
                    : colors.black
                }`,
                "data-index": props.index,
                ontouchend: (event) =>
                  handleDrop({ event, movingPiece, history, possibleMoves }),
                onmouseup: (event) =>
                  handleDrop({ event, movingPiece, history, possibleMoves }),
              },
              () => {
                const squareValue = history.val.at(-1)[props.index];
                if (squareValue !== 0) {
                  const type = initialPiecesPosition[(squareValue - 1) % 4];
                  const color =
                    squareValue - 1 < initialPiecesPosition.length
                      ? colors.white
                      : colors.black;
                  const pieceName = getPieceName({ piece: type, color });

                  return piece({
                    src: `/public/${pieceName}.svg`,
                    "data-type": type,
                    "data-color": color,
                    "data-index": squareValue,
                  });
                }
              }
            );
        };

        const board = () =>
          div(
            {
              className: "board",
            },
            squares.map((color, index) => square({ color, index }))
          );

        const game = div(
          bank({ color: colors.black }),
          board,
          bank({ color: colors.white })
        );

        return game;
      };

      van.add(document.body, renderGame());
    </script>
  </body>
</html>
